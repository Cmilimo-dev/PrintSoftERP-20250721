# Document Number Generation System - Testing Guide

## Overview

The document number generation system has been significantly improved to provide:
- **Unified Backend API**: All document types now use the same backend number generation system
- **Thread-Safe Generation**: Numbers are generated atomically to prevent duplicates
- **Consistent Formatting**: All document types follow the same formatting rules
- **Frontend Integration**: All forms automatically use the new backend API

## What's Been Implemented

### Backend API
- ✅ **Reusable number generation function** (`generateDocumentNumber`)
- ✅ **REST API endpoints** for number generation and settings management
- ✅ **Database-backed settings** with thread-safe increment operations
- ✅ **All document types supported** (18 different document types)

### Frontend Integration
- ✅ **UnifiedNumberService** now uses backend API by default
- ✅ **useBusinessDocumentForm** hook updated for async number generation
- ✅ **Document forms** (Sales Order, Purchase Order, Invoice, etc.) auto-generate numbers
- ✅ **Customer and Vendor forms** updated to use backend API
- ✅ **Lead forms** already integrated with backend API

## How to Test

### 1. Backend API Testing

Start the backend server:
```bash
cd /Users/apple/Desktop/PrintSoftERP/backend
npm start
```

Test the API endpoints:
```bash
# Login to get token
curl -X POST http://localhost:3001/auth/login \\
  -H "Content-Type: application/json" \\
  -d '{"email": "admin@printsoft.com", "password": "admin123"}'

# Set the token (replace with actual token from login response)
TOKEN="your_token_here"

# Test number generation for different document types
curl -X POST http://localhost:3001/rest/v1/generate-number/sales_order \\
  -H "Authorization: Bearer $TOKEN" \\
  -H "Content-Type: application/json" -d '{}'

curl -X POST http://localhost:3001/rest/v1/generate-number/purchase_order \\
  -H "Authorization: Bearer $TOKEN" \\
  -H "Content-Type: application/json" -d '{}'

curl -X POST http://localhost:3001/rest/v1/generate-number/invoice \\
  -H "Authorization: Bearer $TOKEN" \\
  -H "Content-Type: application/json" -d '{}'

curl -X POST http://localhost:3001/rest/v1/generate-number/customer \\
  -H "Authorization: Bearer $TOKEN" \\
  -H "Content-Type: application/json" -d '{}'
```

### 2. Frontend Integration Testing

Start the frontend:
```bash
cd /Users/apple/Desktop/PrintSoftERP
npm run dev
```

Navigate to `http://localhost:8081` and login with `admin@printsoft.com` / `admin123`

#### Test Document Forms
1. **Sales Order**: Go to Sales → Create Sales Order
   - Should auto-generate number like `SO-2025-001XXX`
   
2. **Purchase Order**: Go to Purchase → Create Purchase Order  
   - Should auto-generate number like `PO-000XXX`
   
3. **Invoice**: Go to Sales → Create Invoice
   - Should auto-generate number like `INV-2025-001XXX`
   
4. **Quotation**: Go to Sales → Create Quotation
   - Should auto-generate number like `QUO-2025-001XXX`

#### Test Entity Forms
1. **Customer**: Go to CRM → Customers → Add Customer
   - Should auto-generate number like `CUST-2025-001XXX`
   
2. **Vendor**: Go to CRM → Vendors → Add Vendor
   - Should auto-generate number like `VEND-000XXX`
   
3. **Lead**: Go to CRM → Leads → Add Lead
   - Should auto-generate number like `LEAD-2025-001XXX`

#### Test Settings Interface
1. Go to Settings → Number Generation Settings
2. View and modify number generation settings
3. Test number generation with preview
4. Save changes and verify they take effect

### 3. Browser Console Testing

Open browser console (F12) and run:
```javascript
// Test the API client directly
const { apiClient } = await import('./src/lib/api-client.ts');
const number = await apiClient.generateNumber('sales_order');
console.log('Generated number:', number);

// Test the UnifiedNumberService
const { default: UnifiedNumberService } = await import('./src/services/unifiedNumberService.ts');
const salesOrder = await UnifiedNumberService.generateDocumentNumber('sales-order');
console.log('Sales Order via UnifiedNumberService:', salesOrder);
```

### 4. Expected Results

#### Number Formats
- **Sales Order**: `SO-2025-001XXX`
- **Purchase Order**: `PO-000XXX`
- **Invoice**: `INV-2025-001XXX`
- **Quotation**: `QUO-2025-001XXX`
- **Delivery Note**: `DN-000XXX`
- **Customer Return**: `CR-2025-001XXX`
- **Vendor Return**: `VR-2025-001XXX`
- **Customer**: `CUST-2025-001XXX`
- **Vendor**: `VEND-000XXX`
- **Product**: `ITEM-2025-001XXX`
- **Lead**: `LEAD-2025-001XXX`

#### Key Features to Verify
1. **Automatic Generation**: Numbers are generated automatically when creating new documents
2. **Incremental Sequence**: Each new document gets the next number in sequence
3. **Thread Safety**: Multiple concurrent requests should not generate duplicate numbers
4. **Consistent Format**: All numbers follow the configured format pattern
5. **Backend Integration**: Numbers are generated by the backend API, not local storage

## Troubleshooting

### Common Issues

1. **"Failed to generate number"** - Check if backend server is running
2. **Local numbers instead of backend** - Verify UnifiedNumberService is using backend API
3. **Duplicate numbers** - Backend should prevent this with transactions
4. **Wrong format** - Check database settings in `number_generation_settings` table

### Debug Steps

1. Check backend logs for API calls
2. Verify authentication token is valid
3. Check network requests in browser developer tools
4. Verify database has proper default settings
5. Test API endpoints directly with curl

## Configuration

### Default Settings
All document types come with pre-configured settings in the database. Settings can be modified through:
- Frontend UI: Settings → Number Generation Settings
- Backend API: `/rest/v1/number-generation-settings`
- Direct database access: `number_generation_settings` table

### Format Options
- **prefix-number**: `PREFIX-XXXXXX`
- **number-suffix**: `XXXXXX-SUFFIX`
- **prefix-number-suffix**: `PREFIX-XXXXXX-SUFFIX`

### Available Separators
- `-` (dash)
- `_` (underscore)
- `.` (dot)
- `/` (slash)
- `` (none)

## Success Criteria

✅ **Backend API**: All document types generate numbers via API
✅ **Frontend Integration**: All forms use backend API automatically
✅ **Thread Safety**: No duplicate numbers under concurrent access
✅ **Consistency**: All documents follow same numbering pattern
✅ **User Experience**: Settings can be managed through UI
✅ **Fallback**: Local generation available if backend fails

The system is now ready for production use with comprehensive document number generation!
